<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Sophia - Voz Inteligente</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 900px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #2c3e50, #9b59b6);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }
    .header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }
    .content {
      padding: 30px;
    }
    .voice-section {
      text-align: center;
      margin-bottom: 30px;
    }
    .voice-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      font-size: 3rem;
      cursor: pointer;
      transition: all 0.3s;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .voice-btn.listen {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
    }
    .voice-btn.listening {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      animation: pulse 1.5s infinite;
    }
    .voice-btn:hover {
      transform: scale(1.05);
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .transcription-display {
      background: #f9f9f9;
      border-radius: 15px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      margin: 20px 0;
      min-height: 100px;
      max-height: 200px;
      overflow-y: auto;
    }
    .transcription-text {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #333;
      text-align: center;
    }
    .interim {
      color: #999;
      font-style: italic;
    }
    .final {
      color: #333;
      font-weight: 500;
    }
    .response-section {
      background: #f9f9f9;
      border-radius: 15px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .panel-title {
      font-weight: 600;
      color: #2c3e50;
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }
    .response-content {
      font-size: 1rem;
      line-height: 1.6;
      color: #333;
    }
    .response-item {
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
      background: white;
      border-left: 4px solid #9b59b6;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .speech-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
    }
    .speech-btn {
      background: #3498db;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
      transition: all 0.3s;
    }
    .speech-btn:hover {
      background: #2980b9;
      transform: scale(1.1);
    }
    .speech-btn.playing {
      background: #e74c3c;
    }
    .status-bar {
      padding: 15px;
      background: #f5f5f5;
      border-radius: 15px;
      text-align: center;
      font-size: 1rem;
      color: #666;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .status-bar.active {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    .btn-secondary {
      background: #95a5a6;
      color: white;
    }
    .btn-secondary:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
    }
    .btn-primary {
      background: #9b59b6;
      color: white;
    }
    .btn-primary:hover {
      background: #8e44ad;
      transform: translateY(-2px);
    }
    .instructions {
      text-align: center;
      margin-bottom: 20px;
      color: #666;
      font-size: 0.9rem;
    }
    .auto-speech-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #9b59b6;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>üé§ Assistente Sophia - Voz Inteligente</h1>
      <p>Especialista em Java Backend e Direito para Concursos</p>
    </div>

    <div class="content">
      <div class="instructions">
        <p>Clique no microfone e comece a falar. Sua voz ser√° transcrita e enviada para a IA automaticamente.</p>
      </div>

      <div class="auto-speech-toggle">
        <label for="autoSpeech">Leitura autom√°tica de respostas:</label>
        <label class="toggle-switch">
          <input type="checkbox" id="autoSpeech" checked>
          <span class="slider"></span>
        </label>
      </div>

      <div class="voice-section">
        <button class="voice-btn listen" id="voiceButton" onclick="toggleVoiceRecognition()">
          üé§
        </button>
        <p id="voiceStatus">Clique no microfone para come√ßar</p>
      </div>

      <div class="transcription-display">
        <div class="panel-title">
          <span>üó£Ô∏è</span>
          <span>Sua Fala Transcrita</span>
        </div>
        <div class="transcription-text" id="transcriptionText">
          <p style="color: #999;">Sua fala aparecer√° aqui...</p>
        </div>
      </div>

      <div class="response-section">
        <div class="panel-title">
          <span>ü§ñ</span>
          <span>Resposta da IA</span>
        </div>
        <div class="response-content" id="responseText">
          <p style="color: #999;">As respostas da IA aparecer√£o aqui...</p>
        </div>
      </div>

      <div class="status-bar" id="statusBar">
        <span id="statusText">Pronto para escutar</span>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" onclick="clearAll()">
          üóëÔ∏è Limpar Tudo
        </button>
        <button class="btn btn-primary" onclick="stopAllSpeech()">
          ‚èπÔ∏è Parar Voz
        </button>
      </div>
    </div>
  </div>

  <script>
    let recognition = null;
    let isListening = false;
    let currentTranscript = '';
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let isProcessing = false; // Evita m√∫ltiplas chamadas √† API

    window.onload = function() {
      initializeRecognition();
      if (!speechSynthesis) {
        console.warn('S√≠ntese de voz n√£o suportada neste navegador');
        document.getElementById('autoSpeech').disabled = true;
      }
    };

    function initializeRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        updateStatus('‚ùå Reconhecimento de voz n√£o suportado', false);
        document.getElementById('voiceButton').disabled = true;
        document.getElementById('voiceStatus').textContent = 'Navegador n√£o suporta reconhecimento de voz';
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'pt-BR';

      recognition.onstart = function() {
        isListening = true;
        updateVoiceUI(true);
        updateStatus('üé§ Escutando... Fale agora!', true);
      };

      recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        if (interimTranscript.trim()) {
          updateTranscription(interimTranscript, true);
          currentTranscript = interimTranscript;
        }

        // S√≥ envia para IA quando h√° transcri√ß√£o final E n√£o est√° processando outra
        if (finalTranscript.trim() && !isProcessing) {
          updateTranscription(finalTranscript, false);
          currentTranscript = finalTranscript;
          sendToAI(finalTranscript.trim());
        }
      };

      recognition.onerror = function(event) {
        console.error('Erro no reconhecimento:', event.error);
        if (event.error === 'no-speech') {
          updateStatus('üé§ Nenhuma fala detectada. Continue falando...', true);
        } else if (event.error === 'audio-capture') {
          updateStatus('‚ùå Erro no microfone. Verifique as permiss√µes.', false);
          stopVoiceRecognition();
        } else if (event.error === 'not-allowed') {
          updateStatus('‚ùå Permiss√£o de microfone negada.', false);
          stopVoiceRecognition();
        }
      };

      recognition.onend = function() {
        if (isListening) {
          recognition.start();
        } else {
          updateVoiceUI(false);
          updateStatus('‚è∏Ô∏è Escuta parada', false);
        }
      };
    }

    function speakText(text, responseId = null) {
      if (!speechSynthesis) return;
      
      stopSpeech();
      
      const utterance = new SpeechSynthesisUtterance(text);
      
      // Configura√ß√µes otimizadas para voz
      utterance.lang = 'pt-BR';
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      
      // Seleciona a melhor voz dispon√≠vel
      const voices = speechSynthesis.getVoices();
      
      // Prioridade: voz feminina em portugu√™s brasileiro
      let selectedVoice = voices.find(voice => 
        voice.lang === 'pt-BR' && voice.name.toLowerCase().includes('female')
      ) || voices.find(voice => 
        voice.lang === 'pt-BR' && voice.name.toLowerCase().includes('feminina')
      ) || voices.find(voice => 
        voice.lang === 'pt-BR'
      ) || voices.find(voice => 
        voice.lang.includes('pt')
      );
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
        console.log('Usando voz:', selectedVoice.name);
      }
      
      if (responseId) {
        const playButton = document.querySelector(`[data-response="${responseId}"]`);
        if (playButton) {
          playButton.classList.add('playing');
          playButton.innerHTML = '‚è∏Ô∏è';
        }
      }
      
      utterance.onend = function() {
        if (responseId) {
          const playButton = document.querySelector(`[data-response="${responseId}"]`);
          if (playButton) {
            playButton.classList.remove('playing');
            playButton.innerHTML = 'üîä';
          }
        }
        currentUtterance = null;
      };
      
      utterance.onerror = function() {
        if (responseId) {
          const playButton = document.querySelector(`[data-response="${responseId}"]`);
          if (playButton) {
            playButton.classList.remove('playing');
            playButton.innerHTML = 'üîä';
          }
        }
        currentUtterance = null;
      };
      
      currentUtterance = utterance;
      speechSynthesis.speak(utterance);
    }

    function stopSpeech() {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      currentUtterance = null;
      
      document.querySelectorAll('.speech-btn.playing').forEach(btn => {
        btn.classList.remove('playing');
        btn.innerHTML = 'üîä';
      });
    }

    function stopAllSpeech() {
      stopSpeech();
      updateStatus('‚èπÔ∏è Voz parada', false);
    }

    function toggleVoiceRecognition() {
      if (!recognition) {
        alert('Reconhecimento de voz n√£o dispon√≠vel');
        return;
      }

      if (isListening) {
        stopVoiceRecognition();
      } else {
        startVoiceRecognition();
      }
    }

    function startVoiceRecognition() {
      isListening = true;
      recognition.start();
    }

    function stopVoiceRecognition() {
      isListening = false;
      recognition.stop();
    }

    function updateVoiceUI(listening) {
      const voiceButton = document.getElementById('voiceButton');
      const voiceStatus = document.getElementById('voiceStatus');
      
      if (listening) {
        voiceButton.classList.remove('listen');
        voiceButton.classList.add('listening');
        voiceButton.textContent = 'üõë';
        voiceStatus.textContent = 'Ouvindo... Fale agora!';
      } else {
        voiceButton.classList.remove('listening');
        voiceButton.classList.add('listen');
        voiceButton.textContent = 'üé§';
        voiceStatus.textContent = 'Clique no microfone para come√ßar';
      }
    }

    function updateTranscription(text, isInterim) {
      const transcriptionDiv = document.getElementById('transcriptionText');
      
      if (isInterim) {
        transcriptionDiv.innerHTML = `<span class="interim">${text}</span>`;
      } else {
        transcriptionDiv.innerHTML = `<span class="final">${text}</span>`;
      }
    }

    async function sendToAI(transcript) {
    if (!transcript.trim() || isProcessing) return;

    isProcessing = true;
    updateStatus('üß† Enviando para IA...', true);
    
    const responseDiv = document.getElementById('responseText');
    
    if (responseDiv.querySelector('p[style*="color: #999"]')) {
        responseDiv.innerHTML = '';
    }
    
    const loadingElement = document.createElement('div');
    loadingElement.innerHTML = '<span class="loading"></span> Processando sua pergunta...';
    responseDiv.appendChild(loadingElement);
    responseDiv.scrollTop = responseDiv.scrollHeight;

    try {
        // CORRE√á√ÉO: Enviar no formato que o backend espera
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: transcript  // Formato correto para o backend
            })
        });

        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        responseDiv.removeChild(loadingElement);
        
        const responseId = Date.now().toString();
        const answerElement = document.createElement('div');
        answerElement.className = 'response-item';
        
        // CORRE√á√ÉO: Escapar caracteres especiais para evitar erros no HTML
        const safeResponse = data.response.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
        
        answerElement.innerHTML = `
            <div class="speech-controls">
                <button class="speech-btn" data-response="${responseId}" 
                        onclick="speakText('${safeResponse}', '${responseId}')">üîä</button>
            </div>
            ${data.response}
        `;
        responseDiv.appendChild(answerElement);
        responseDiv.scrollTop = responseDiv.scrollHeight;
        
        const autoSpeech = document.getElementById('autoSpeech').checked;
        if (autoSpeech && speechSynthesis) {
            setTimeout(() => {
                speakText(data.response, responseId);
            }, 500);
        }
        
        updateStatus('‚úÖ Resposta recebida! Continue falando...', true);

    } catch (error) {
        console.error('Erro ao chamar IA:', error);
        
        if (responseDiv.contains(loadingElement)) {
            responseDiv.removeChild(loadingElement);
        }
        
        const errorElement = document.createElement('div');
        errorElement.innerHTML = `<span style="color: red;">‚ùå Erro: ${error.message}</span>`;
        responseDiv.appendChild(errorElement);
        responseDiv.scrollTop = responseDiv.scrollHeight;
        
        updateStatus('‚ùå Erro na conex√£o com IA', false);
    } finally {
        isProcessing = false;
    }
}

    function updateStatus(message, isActive) {
      const statusBar = document.getElementById('statusBar');
      const statusText = document.getElementById('statusText');
      
      statusText.textContent = message;
      
      if (isActive) {
        statusBar.classList.add('active');
      } else {
        statusBar.classList.remove('active');
      }
    }

    function clearAll() {
      document.getElementById('transcriptionText').innerHTML = '<p style="color: #999;">Sua fala aparecer√° aqui...</p>';
      document.getElementById('responseText').innerHTML = '<p style="color: #999;">As respostas da IA aparecer√£o aqui...</p>';
      currentTranscript = '';
      stopAllSpeech();
      
      if (isListening) {
        updateStatus('üé§ Escutando... Fale agora!', true);
      } else {
        updateStatus('Pronto para escutar', false);
      }
    }

    speechSynthesis.onvoiceschanged = function() {
      console.log('Vozes dispon√≠veis:', speechSynthesis.getVoices());
    };
  </script>

</body>
</html>